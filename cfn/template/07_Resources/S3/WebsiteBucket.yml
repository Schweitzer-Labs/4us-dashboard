WebsiteBucket:
  Type: AWS::S3::Bucket
  DeletionPolicy: Retain
  Properties:
    BucketName: !Sub ${SubDomain}-${RunEnvironment}.${Domain}.${TLD}-${AWS::Region}
    AccessControl: Private
    PublicAccessBlockConfiguration:
      BlockPublicAcls: true
      IgnorePublicAcls: false
      BlockPublicPolicy: true
      RestrictPublicBuckets: true
    BucketEncryption:
      ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
    VersioningConfiguration:
      Status: Enabled
{% if RUNENV == 'prod' %}
    ReplicationConfiguration:
      Role: !Ref WebsiteReplicationRoleArn
      Rules:
        - Id: BackupToCalifornia
          Status: Enabled
          Destination:
            Bucket: !Sub arn:aws:s3:::${SubDomain}-${RunEnvironment}.${Domain}.${TLD}-us-west-1
            StorageClass: STANDARD
          #SourceSelectionCriteria:
          # ReplicaModifications:
          #   Status: Enabled
          # SseKmsEncryptedObjects:
          #   Status: Enabled
{% endif %}

WebsiteBucketPolicy:
  Type: AWS::S3::BucketPolicy
  DependsOn: OAI
  Properties:
    Bucket: !Ref WebsiteBucket
    PolicyDocument:
      Version: '2012-10-17'
      Statement:
        - Sid: AlloWSSLRequestsOnly
          Effect: Deny
          Resource:
            - !Sub ${WebsiteBucket.Arn}
            - !Sub ${WebsiteBucket.Arn}/*
          Action: s3:*
          Condition:
            Bool:
              aws:SecureTransport: false
          Principal: '*'
        - Sid: AllowCloudFrontAccess
          Effect: Allow
          Resource: !Sub ${WebsiteBucket.Arn}/*
          Action: s3:GetObject
          Principal:
            AWS: !Sub arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${OAI}
